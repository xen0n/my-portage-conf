From b16ec81dd40d16c61955dccdfa7dde41b0725bb0 Mon Sep 17 00:00:00 2001
From: WANG Xuerui <git@xen0n.name>
Date: Sun, 8 Aug 2021 12:01:09 +0800
Subject: [PATCH 08/11] LoongArch: make all non-native jumps desugar to
 canonical b{gt/le}[u] forms

---
 opcodes/loongarch-opc.c | 70 +++++++++++++++++++----------------------
 1 file changed, 32 insertions(+), 38 deletions(-)

diff --git a/opcodes/loongarch-opc.c b/opcodes/loongarch-opc.c
index 541d660a972..fd3dc55707c 100644
--- a/opcodes/loongarch-opc.c
+++ b/opcodes/loongarch-opc.c
@@ -21,7 +21,7 @@
 #include <stddef.h>
 #include "opcode/loongarch.h"
 
-struct loongarch_ASEs_option LARCH_opts = 
+struct loongarch_ASEs_option LARCH_opts =
 {
   .ase_test = 0,
   .ase_fix = 0,
@@ -47,7 +47,7 @@ loongarch_insn_length (insn_t insn)
   return insn ? 4 : 4; /* eliminate warning */
 }
 
-const char *const loongarch_r_normal_name[32] = 
+const char *const loongarch_r_normal_name[32] =
 {
   "$r0",  "$r1",  "$r2",  "$r3",  "$r4",  "$r5",  "$r6",  "$r7",
   "$r8",  "$r9",  "$r10", "$r11", "$r12", "$r13", "$r14", "$r15",
@@ -55,7 +55,7 @@ const char *const loongarch_r_normal_name[32] =
   "$r24", "$r25", "$r26", "$r27", "$r28", "$r29", "$r30", "$r31",
 };
 
-const char *const loongarch_r_lp64_name[32] = 
+const char *const loongarch_r_lp64_name[32] =
 {
   "$zero", "$ra", "$tp", "$sp", "$a0", "$a1", "$a2", "$a3",
   "$a4",   "$a5", "$a6", "$a7", "$t0", "$t1", "$t2", "$t3",
@@ -63,13 +63,13 @@ const char *const loongarch_r_lp64_name[32] =
   "$s1",   "$s2", "$s3", "$s4", "$s5", "$s6", "$s7", "$s8",
 };
 
-const char *const loongarch_r_lp64_name1[32] = 
+const char *const loongarch_r_lp64_name1[32] =
 {
   "", "", "", "", "$v0", "$v1", "", "", "", "", "", "", "", "", "", "",
   "", "", "", "", "",    "",    "", "", "", "", "", "", "", "", "", "",
 };
 
-const char *const loongarch_f_normal_name[32] = 
+const char *const loongarch_f_normal_name[32] =
 {
   "$f0",  "$f1",  "$f2",  "$f3",  "$f4",  "$f5",  "$f6",  "$f7",
   "$f8",  "$f9",  "$f10", "$f11", "$f12", "$f13", "$f14", "$f15",
@@ -77,7 +77,7 @@ const char *const loongarch_f_normal_name[32] =
   "$f24", "$f25", "$f26", "$f27", "$f28", "$f29", "$f30", "$f31",
 };
 
-const char *const loongarch_f_lp64_name[32] = 
+const char *const loongarch_f_lp64_name[32] =
 {
   "$fa0", "$fa1", "$fa2",  "$fa3",  "$fa4",  "$fa5",  "$fa6",  "$fa7",
   "$ft0", "$ft1", "$ft2",  "$ft3",  "$ft4",  "$ft5",  "$ft6",  "$ft7",
@@ -85,18 +85,18 @@ const char *const loongarch_f_lp64_name[32] =
   "$fs0", "$fs1", "$fs2",  "$fs3",  "$fs4",  "$fs5",  "$fs6",  "$fs7",
 };
 
-const char *const loongarch_f_lp64_name1[32] = 
+const char *const loongarch_f_lp64_name1[32] =
 {
   "$fv0", "$fv1", "", "", "", "", "", "", "", "", "", "", "", "", "", "",
   "",     "",     "", "", "", "", "", "", "", "", "", "", "", "", "", "",
 };
 
-const char *const loongarch_c_normal_name[8] = 
+const char *const loongarch_c_normal_name[8] =
 {
   "$fcc0", "$fcc1", "$fcc2", "$fcc3", "$fcc4", "$fcc5", "$fcc6", "$fcc7",
 };
 
-const char *const loongarch_cr_normal_name[4] = 
+const char *const loongarch_cr_normal_name[4] =
 {
   "$scr0",
   "$scr1",
@@ -104,7 +104,7 @@ const char *const loongarch_cr_normal_name[4] =
   "$scr3",
 };
 
-const char *const loongarch_v_normal_name[32] = 
+const char *const loongarch_v_normal_name[32] =
 {
   "$vr0",  "$vr1",  "$vr2",  "$vr3",  "$vr4",  "$vr5",  "$vr6",  "$vr7",
   "$vr8",  "$vr9",  "$vr10", "$vr11", "$vr12", "$vr13", "$vr14", "$vr15",
@@ -112,7 +112,7 @@ const char *const loongarch_v_normal_name[32] =
   "$vr24", "$vr25", "$vr26", "$vr27", "$vr28", "$vr29", "$vr30", "$vr31",
 };
 
-const char *const loongarch_x_normal_name[32] = 
+const char *const loongarch_x_normal_name[32] =
 {
   "$xr0",  "$xr1",  "$xr2",  "$xr3",  "$xr4",  "$xr5",  "$xr6",  "$xr7",
   "$xr8",  "$xr9",  "$xr10", "$xr11", "$xr12", "$xr13", "$xr14", "$xr15",
@@ -120,7 +120,7 @@ const char *const loongarch_x_normal_name[32] =
   "$xr24", "$xr25", "$xr26", "$xr27", "$xr28", "$xr29", "$xr30", "$xr31",
 };
 
-static struct loongarch_opcode loongarch_macro_opcodes[] = 
+static struct loongarch_opcode loongarch_macro_opcodes[] =
 {
   /* match,    mask,       name, format, macro, include, exclude, pinfo */
   {0, 0, "li.w", "r,sc", "%f", 0, 0, 0},
@@ -276,7 +276,7 @@ static struct loongarch_opcode loongarch_macro_opcodes[] =
   { 0 } /* Terminate the list.  */
 };
 
-static struct loongarch_opcode loongarch_fix_opcodes[] = 
+static struct loongarch_opcode loongarch_fix_opcodes[] =
 {
   /* match,    mask,       name, format, macro, include, exclude, pinfo */
   { 0x00001000, 0xfffffc00, "clo.w", "r0:5,r5:5", 0, 0, 0, 0 },
@@ -375,7 +375,7 @@ static struct loongarch_opcode loongarch_fix_opcodes[] =
   { 0 } /* Terminate the list.  */
 };
 
-static struct loongarch_opcode loongarch_float_opcodes[] = 
+static struct loongarch_opcode loongarch_float_opcodes[] =
 {
   /* match,    mask,       name, format, macro, include, exclude, pinfo */
   { 0x01008000, 0xffff8000, "fadd.s", "f0:5,f5:5,f10:5", 0, 0, 0, 0 },
@@ -457,7 +457,7 @@ static struct loongarch_opcode loongarch_float_opcodes[] =
   { 0 } /* Terminate the list.  */
 };
 
-static struct loongarch_opcode loongarch_lmm_opcodes[] = 
+static struct loongarch_opcode loongarch_lmm_opcodes[] =
 {
   /* match,    mask,       name, format, macro, include, exclude, pinfo */
   { 0x02000000, 0xffc00000, "slti", "r0:5,r5:5,s10:12", 0, 0, 0, 0 },
@@ -479,7 +479,7 @@ static struct loongarch_opcode loongarch_lmm_opcodes[] =
   { 0 } /* Terminate the list.  */
 };
 
-static struct loongarch_opcode loongarch_privilege_opcodes[] = 
+static struct loongarch_opcode loongarch_privilege_opcodes[] =
 {
   /* match,    mask,       name, format, macro, include, exclude, pinfo */
   { 0x04000000, 0xff0003e0, "csrrd", "r0:5,u10:14", 0, 0, 0, 0 },
@@ -508,7 +508,7 @@ static struct loongarch_opcode loongarch_privilege_opcodes[] =
   { 0 } /* Terminate the list.  */
 };
 
-static struct loongarch_opcode loongarch_4opt_opcodes[] = 
+static struct loongarch_opcode loongarch_4opt_opcodes[] =
 {
   /* match,    mask,       name, format, macro, include, exclude, pinfo */
   { 0x08100000, 0xfff00000, "fmadd.s", "f0:5,f5:5,f10:5,f15:5", 0, 0, 0, 0 },
@@ -575,7 +575,7 @@ static struct loongarch_opcode loongarch_4opt_opcodes[] =
   { 0 } /* Terminate the list.  */
 };
 
-static struct loongarch_opcode loongarch_load_store_opcodes[] = 
+static struct loongarch_opcode loongarch_load_store_opcodes[] =
 {
   /* match,    mask,       name, format, macro, include, exclude, pinfo */
   { 0x20000000, 0xff000000, "ll.w", "r0:5,r5:5,s10:14<<2", 0, 0, 0, 0 },
@@ -719,17 +719,9 @@ static struct loongarch_opcode loongarch_load_store_opcodes[] =
   { 0 } /* Terminate the list.  */
 };
 
-static struct loongarch_opcode loongarch_jmp_opcodes[] = 
+static struct loongarch_opcode loongarch_jmp_opcodes[] =
 {
   /* match,    mask,       name, format, macro, include, exclude, pinfo */
-  { 0, 0, "bltz", "r,la", "bltz %1,%%pcrel(%2)", 0, 0, 0 },
-  { 0x60000000, 0xfc00001f, "bltz", "r5:5,sb10:16<<2", 0, 0, 0, 0 },
-  { 0, 0, "bgtz", "r,la", "bgtz %1,%%pcrel(%2)", 0, 0, 0 },
-  { 0x60000000, 0xfc0003e0, "bgtz", "r0:5,sb10:16<<2", 0, 0, 0, 0 },
-  { 0, 0, "bgez", "r,la", "bgez %1,%%pcrel(%2)", 0, 0, 0 },
-  { 0x64000000, 0xfc00001f, "bgez", "r5:5,sb10:16<<2", 0, 0, 0, 0 },
-  { 0, 0, "blez", "r,la", "blez %1,%%pcrel(%2)", 0, 0, 0 },
-  { 0x64000000, 0xfc0003e0, "blez", "r0:5,sb10:16<<2", 0, 0, 0, 0 },
   { 0, 0, "beqz", "r,la", "beqz %1,%%pcrel(%2)", 0, 0, 0 },
   { 0x40000000, 0xfc000000, "beqz", "r5:5,sb0:5|10:16<<2", 0, 0, 0, 0 },
   { 0, 0, "bnez", "r,la", "bnez %1,%%pcrel(%2)", 0, 0, 0 },
@@ -738,36 +730,38 @@ static struct loongarch_opcode loongarch_jmp_opcodes[] =
   { 0x48000000, 0xfc000300, "bceqz", "c5:3,sb0:5|10:16<<2", 0, 0, 0, 0 },
   { 0, 0, "bcnez", "c,la", "bcnez %1,%%pcrel(%2)", 0, 0, 0 },
   { 0x48000100, 0xfc000300, "bcnez", "c5:3,sb0:5|10:16<<2", 0, 0, 0, 0 },
-  { 0, 0, "jr", "r", "jirl $r0,%1,0", 0, 0, 0 },
+  { 0x4c000000, 0xfc000000, "jirl", "r0:5,r5:5,s10:16<<2", 0, 0, 0, 0 },
   { 0, 0, "b", "la", "b %%pcrel(%1)", 0, 0, 0},
   { 0x50000000, 0xfc000000, "b", "sb0:10|10:16<<2", 0, 0, 0, 0},
-  { 0x4c000000, 0xfc000000, "jirl", "r0:5,r5:5,s10:16<<2", 0, 0, 0, 0 },
   { 0, 0, "bl", "la", "bl %%pcrel(%1)", 0, 0, 0 },
   { 0x54000000, 0xfc000000, "bl", "sb0:10|10:16<<2", 0, 0, 0, 0 },
   { 0, 0, "beq", "r,r,la", "beq %1,%2,%%pcrel(%3)", 0, 0, 0 },
   { 0x58000000, 0xfc000000, "beq", "r5:5,r0:5,sb10:16<<2", 0, 0, 0, 0 },
   { 0, 0, "bne", "r,r,la", "bne %1,%2,%%pcrel(%3)", 0, 0, 0 },
   { 0x5c000000, 0xfc000000, "bne", "r5:5,r0:5,sb10:16<<2", 0, 0, 0, 0 },
-  { 0, 0, "blt", "r,r,la", "blt %1,%2,%%pcrel(%3)", 0, 0, 0 },
-  { 0x60000000, 0xfc000000, "blt", "r5:5,r0:5,sb10:16<<2", 0, 0, 0, 0 },
   { 0, 0, "bgt", "r,r,la", "bgt %1,%2,%%pcrel(%3)", 0, 0, 0 },
   { 0x60000000, 0xfc000000, "bgt", "r0:5,r5:5,sb10:16<<2", 0, 0, 0, 0 },
-  { 0, 0, "bge", "r,r,la", "bge %1,%2,%%pcrel(%3)", 0, 0, 0 },
-  { 0x64000000, 0xfc000000, "bge", "r5:5,r0:5,sb10:16<<2", 0, 0, 0, 0 },
   { 0, 0, "ble", "r,r,la", "ble %1,%2,%%pcrel(%3)", 0, 0, 0 },
   { 0x64000000, 0xfc000000, "ble", "r0:5,r5:5,sb10:16<<2", 0, 0, 0, 0 },
-  { 0, 0, "bltu", "r,r,la", "bltu %1,%2,%%pcrel(%3)", 0, 0, 0 },
-  { 0x68000000, 0xfc000000, "bltu", "r5:5,r0:5,sb10:16<<2", 0, 0, 0, 0 },
   { 0, 0, "bgtu", "r,r,la", "bgtu %1,%2,%%pcrel(%3)", 0, 0, 0 },
   { 0x68000000, 0xfc000000, "bgtu", "r0:5,r5:5,sb10:16<<2", 0, 0, 0, 0 },
-  { 0, 0, "bgeu", "r,r,la", "bgeu %1,%2,%%pcrel(%3)", 0, 0, 0 },
-  { 0x6c000000, 0xfc000000, "bgeu", "r5:5,r0:5,sb10:16<<2", 0, 0, 0, 0 },
   { 0, 0, "bleu", "r,r,la", "bleu %1,%2,%%pcrel(%3)", 0, 0, 0 },
   { 0x6c000000, 0xfc000000, "bleu", "r0:5,r5:5,sb10:16<<2", 0, 0, 0, 0 },
+
+  { 0, 0, "bltz", "r,la", "bgt $r0,%1,%%pcrel(%2)", 0, 0, 0 },
+  { 0, 0, "bgtz", "r,la", "bgt %1,$r0,%%pcrel(%2)", 0, 0, 0 },
+  { 0, 0, "bgez", "r,la", "ble $r0,%1,%%pcrel(%2)", 0, 0, 0 },
+  { 0, 0, "blez", "r,la", "ble %1,$r0,%%pcrel(%2)", 0, 0, 0 },
+  { 0, 0, "blt", "r,r,la", "bgt %2,%1,%%pcrel(%3)", 0, 0, 0 },
+  { 0, 0, "bge", "r,r,la", "ble %2,%1,%%pcrel(%3)", 0, 0, 0 },
+  { 0, 0, "bltu", "r,r,la", "bleu %2,%1,%%pcrel(%3)", 0, 0, 0 },
+  { 0, 0, "bgeu", "r,r,la", "bgtu %2,%1,%%pcrel(%3)", 0, 0, 0 },
+  { 0, 0, "jr", "r", "jirl $r0,%1,0", 0, 0, 0 },
+
   { 0 } /* Terminate the list.  */
 };
 
-struct loongarch_ase loongarch_ASEs[] = 
+struct loongarch_ase loongarch_ASEs[] =
 {
   { &LARCH_opts.ase_fix, loongarch_macro_opcodes, 0, 0, { 0 }, 0, 0 },
   { &LARCH_opts.ase_fix, loongarch_lmm_opcodes, 0, 0, { 0 }, 0, 0 },
-- 
2.30.1

